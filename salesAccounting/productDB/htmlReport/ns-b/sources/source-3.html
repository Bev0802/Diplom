


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1251"> 
  <title>Coverage Report > OrderService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.bev0802.salesaccounting.productdb.service</a>
</div>

<h1>Coverage Summary for Class: OrderService (com.bev0802.salesaccounting.productdb.service)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">OrderService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/129)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.bev0802.salesaccounting.productdb.service;
&nbsp;
&nbsp;import com.bev0802.salesaccounting.productdb.model.*;
&nbsp;import com.bev0802.salesaccounting.productdb.model.enumerator.OrderStatus;
&nbsp;import com.bev0802.salesaccounting.productdb.repository.OrderItemRepository;
&nbsp;import com.bev0802.salesaccounting.productdb.repository.OrderRepository;
&nbsp;import com.bev0802.salesaccounting.productdb.repository.ProductRepository;
&nbsp;import com.bev0802.salesaccounting.productdb.repository.specification.OrderSpecification;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.data.domain.Sort;
&nbsp;import org.springframework.data.jpa.domain.Specification;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;/**
&nbsp; * Сервис для управления заказами в системе учета товаров.
&nbsp; * Предоставляет функционал для создания, подтверждения и отмены заказов,
&nbsp; * а также для получения информации о существующих заказах.
&nbsp; */
&nbsp;@Service
<b class="nc">&nbsp;public class OrderService {</b>
&nbsp;
<b class="nc">&nbsp;    private static final Logger logger = LoggerFactory.getLogger(OrderService.class);</b>
&nbsp;
&nbsp;    @Autowired
&nbsp;    private OrderRepository orderRepository;
&nbsp;    @Autowired
&nbsp;    private OrderItemRepository orderItemRepository;
&nbsp;    @Autowired
&nbsp;    private ProductService productService;
&nbsp;    @Autowired
&nbsp;    private ProductRepository productRepository;
&nbsp;    @Autowired
&nbsp;    private OrganizationService organizationService;
&nbsp;    @Autowired
&nbsp;    private EmployeeService employeeService;
&nbsp;
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Создает новый заказ в системе.
&nbsp;     * Генерирует уникальный номер заказа на основе идентификаторов организаций и сотрудника.
&nbsp;     *
&nbsp;     * @param productId      Идентификатор продукта.
&nbsp;     * @param buyerOrganizationId Идентификатор организации покупателя.
&nbsp;     * @param employeeId     Идентификатор сотрудника.
&nbsp;     * @param quantity       Количество единиц продукта.
&nbsp;     * @param sellerOrganization Объект продавец
&nbsp;     *
&nbsp;     * @return Сохраненный заказ с присвоенным уникальным номером.
&nbsp;     */
&nbsp;
&nbsp;    @Transactional
&nbsp;    public Order createOrder(Long buyerOrganizationId, Long employeeId, Long productId, BigDecimal quantity, Organization sellerOrganization) {
<b class="nc">&nbsp;        Order order = new Order();</b>
&nbsp;
&nbsp;        // Получаем организацию и сотрудника по их ID, выбрасываем исключение, если не найдены
<b class="nc">&nbsp;        Organization buyerOrganization = organizationService.findById(buyerOrganizationId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Organization not found with ID: &quot; + buyerOrganizationId));</b>
<b class="nc">&nbsp;        Employee employee = employeeService.findById(employeeId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Employee not found with ID: &quot; + employeeId));</b>
&nbsp;
&nbsp;        // Устанавливаем покупателя и сотрудника, создавшего заказ
<b class="nc">&nbsp;        order.setBuyerOrganization(buyerOrganization);</b>
<b class="nc">&nbsp;        order.setSellerOrganization(sellerOrganization);</b>
<b class="nc">&nbsp;        order.setEmployee(employee);</b>
<b class="nc">&nbsp;        order.setStatus(OrderStatus.NEW);  // Установка статуса нового заказа</b>
<b class="nc">&nbsp;        order.setOrderDate(LocalDateTime.now()); // Установка текущей даты</b>
<b class="nc">&nbsp;        order.setStatusChangeDate(LocalDateTime.now());</b>
&nbsp;
&nbsp;        // Генерация уникального номера заказа
<b class="nc">&nbsp;        String orderNumber = generateOrderNumber(buyerOrganizationId, sellerOrganization.getId());</b>
<b class="nc">&nbsp;        order.setOrderNumber(orderNumber);</b>
&nbsp;
&nbsp;        // Сохранение заказа в базе данных для получения ID
<b class="nc">&nbsp;        order = orderRepository.save(order);</b>
&nbsp;
&nbsp;        // Создание нового элемента заказа
<b class="nc">&nbsp;        OrderItem orderItem = new OrderItem();</b>
<b class="nc">&nbsp;        Product product = productService.getProductById(productId);</b>
<b class="nc">&nbsp;        orderItem.setProduct(product);</b>
<b class="nc">&nbsp;        orderItem.setQuantity(quantity);</b>
<b class="nc">&nbsp;        orderItem.setPrice(product.getPrice());</b>
<b class="nc">&nbsp;        BigDecimal itemTotal = product.getPrice().multiply(quantity);</b>
<b class="nc">&nbsp;        orderItem.setAmount(itemTotal);</b>
&nbsp;
&nbsp;        // Устанавливаем заказ для OrderItem
<b class="nc">&nbsp;        long orderId = order.getId();</b>
<b class="nc">&nbsp;        orderItem.setOrderId(orderId);</b>
&nbsp;
&nbsp;        // Добавление нового элемента в заказ
<b class="nc">&nbsp;        Set&lt;OrderItem&gt; items = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        items.add(orderItem);</b>
<b class="nc">&nbsp;        order.setItems(items);</b>
&nbsp;
&nbsp;        // Расчет общей стоимости заказа
<b class="nc">&nbsp;        BigDecimal totalAmount = items.stream()</b>
<b class="nc">&nbsp;                .map(OrderItem::getAmount)</b>
<b class="nc">&nbsp;                .reduce(BigDecimal.ZERO, BigDecimal::add);</b>
<b class="nc">&nbsp;        order.setTotalAmount(totalAmount);</b>
&nbsp;
&nbsp;        // Обновление заказа с элементами
<b class="nc">&nbsp;        order = orderRepository.save(order);</b>
&nbsp;
<b class="nc">&nbsp;        logger.info(&quot;ЗАКАЗ после СОХРАНЕНИЯ: {}&quot;, order);</b>
<b class="nc">&nbsp;        logger.info(&quot;ТОВАР после СОХРАНЕНИЯ: {}&quot;, order.getItems());</b>
<b class="nc">&nbsp;        for (OrderItem item : order.getItems()) {</b>
<b class="nc">&nbsp;            logger.info(&quot;Товар: {}, Количество: {}, Цена: {}, Сумма: {}&quot;,</b>
<b class="nc">&nbsp;                    item.getProduct().getName(),</b>
<b class="nc">&nbsp;                    item.getQuantity(),</b>
<b class="nc">&nbsp;                    item.getPrice(),</b>
<b class="nc">&nbsp;                    item.getAmount());</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return order;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Генерирует уникальный номер заказа.
&nbsp;     * Формат номера: &quot;s{buyerId}_b{sellerId}/{sequenceNumber}&quot;.
&nbsp;     *
&nbsp;     * @return Строка, представляющая уникальный номер заказа.
&nbsp;     */
&nbsp;    private String generateOrderNumber(Long buyerOrganizationId, Long sellerOrganizationId) {
<b class="nc">&nbsp;        String prefix = &quot;b&quot; +  buyerOrganizationId + &quot;_s&quot; + sellerOrganizationId;</b>
<b class="nc">&nbsp;        int nextNumber = orderRepository.findNextNumberForPrefix(prefix);</b>
<b class="nc">&nbsp;        return prefix + &quot;/&quot; + nextNumber;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Добавляет продукт в существующий заказ.
&nbsp;     * @param order
&nbsp;     * @param product
&nbsp;     * @param quantity
&nbsp;     * @return
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public Order addItemToOrder(Order order, Product product, BigDecimal quantity) {
&nbsp;        // Получаем список элементов заказа
<b class="nc">&nbsp;        Set&lt;OrderItem&gt; items = order.getItems();</b>
&nbsp;        // Сохраняем текущую общую сумму заказа
<b class="nc">&nbsp;        BigDecimal previousTotalAmount = order.getTotalAmount();</b>
&nbsp;
&nbsp;        // Создание нового элемента заказа
<b class="nc">&nbsp;        OrderItem orderItem = new OrderItem();</b>
<b class="nc">&nbsp;        orderItem.setProduct(product);</b>
<b class="nc">&nbsp;        orderItem.setQuantity(quantity);</b>
<b class="nc">&nbsp;        orderItem.setPrice(product.getPrice());</b>
<b class="nc">&nbsp;        BigDecimal itemTotal = product.getPrice().multiply(quantity);</b>
<b class="nc">&nbsp;        orderItem.setAmount(itemTotal);</b>
&nbsp;        // Привязываем элемент заказа к заказу
<b class="nc">&nbsp;        orderItem.setOrderId(order.getId()); // Установка orderId</b>
&nbsp;
&nbsp;        // Добавляем элемент в заказ и пересчитываем общую стоимость
<b class="nc">&nbsp;        items.add(orderItem);</b>
&nbsp;
&nbsp;        // Пересчитываем общую стоимость заказа, добавляя к предыдущей сумме новую сумму товара
<b class="nc">&nbsp;        BigDecimal totalAmount = previousTotalAmount.add(itemTotal);</b>
<b class="nc">&nbsp;        order.setTotalAmount(totalAmount);</b>
&nbsp;
&nbsp;        // Сохранение заказа в базе данных
<b class="nc">&nbsp;        orderRepository.save(order);</b>
&nbsp;
<b class="nc">&nbsp;        return order;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Находит заказ по его идентификатору.
&nbsp;     *
&nbsp;     * @param id Идентификатор заказа.
&nbsp;     * @return Объект заказа.
&nbsp;     * @throws RuntimeException Если заказ не найден.
&nbsp;     */
&nbsp;    public Order findById(Long id) {
<b class="nc">&nbsp;        return orderRepository.findById(id).orElseThrow(() -&gt; new RuntimeException(&quot;Order not found&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Возвращает список всех заказов в системе.
&nbsp;     *
&nbsp;     * @return Список всех заказов.
&nbsp;     */
&nbsp;    public List&lt;Order&gt; findAll() {
<b class="nc">&nbsp;        return orderRepository.findAll();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Возвращает список заказов, размещенных организацией-покупателем.
&nbsp;     *
&nbsp;     * @param buyer_organization_id Идентификатор организации-покупателя.
&nbsp;     * @return Список заказов, размещенных организацией.
&nbsp;     */
&nbsp;    public List&lt;Order&gt; findOrdersByBuyerId(Long buyer_organization_id) {
<b class="nc">&nbsp;        return orderRepository.findByBuyerOrganizationId(buyer_organization_id);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Возвращает список всех заказов, полученных организацией-продавцом, исключая заказы со статусом NEW.
&nbsp;     *
&nbsp;     * @param seller_organization_id Идентификатор организации-продавца.
&nbsp;     * @return Список заказов, полученных организацией, за исключением тех, что имеют статус NEW.
&nbsp;     */
&nbsp;    public List&lt;Order&gt; findOrdersBySellerIdExcludingNew(Long seller_organization_id) {
<b class="nc">&nbsp;        return orderRepository.findBySellerOrganizationIdAndStatusNot(seller_organization_id, OrderStatus.NEW);</b>
&nbsp;    }
&nbsp;
&nbsp;    //todo: разместить на форме как всплывающее уведомление о вновь поступившем заказе,
&nbsp;    // если не получится удалить.
&nbsp;    /**
&nbsp;     * Возвращает список подтвержденных заказов, полученных организацией-продавцом.
&nbsp;     * Можно использовать как отдельный список вновь полученных заказов.
&nbsp;     *
&nbsp;     * @param sellerId Идентификатор организации-продавца.
&nbsp;     * @return Список подтвержденных заказов, полученных организацией.
&nbsp;     */
&nbsp;    public List&lt;Order&gt; findConfirmedOrdersBySellerId(Long sellerId) {
<b class="nc">&nbsp;        return orderRepository.findBySellerOrganizationIdAndStatus(sellerId, OrderStatus.CONFIRMED);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Получает список всех заказов, созданных конкретным сотрудником.
&nbsp;     *
&nbsp;     * @param employeeId Идентификатор сотрудника.
&nbsp;     * @return Список заказов, созданных сотрудником.
&nbsp;     */
&nbsp;    public List&lt;Order&gt; findOrdersByEmployeeId(Long employeeId) {
<b class="nc">&nbsp;        return orderRepository.findByEmployeeId(employeeId);</b>
&nbsp;    }
&nbsp;
&nbsp;    //#region Изменение статусов заказов
&nbsp;    /**
&nbsp;     * Подтверждает заказ по его идентификатору.
&nbsp;     * Переводит статус заказа в &quot;CONFIRMED&quot; и резервирует товары.
&nbsp;     *
&nbsp;     * @param orderId Идентификатор заказа для подтверждения.
&nbsp;     * @return Обновленный заказ.
&nbsp;     * @throws RuntimeException Если заказ не найден или уже подтвержден.
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public Order confirmOrder(Long orderId) {
<b class="nc">&nbsp;        Order order = orderRepository.findById(orderId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Order not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        if (order.getStatus() == OrderStatus.NEW) {</b>
<b class="nc">&nbsp;            order.setStatus(OrderStatus.CONFIRMED);</b>
<b class="nc">&nbsp;            order.setStatusChangeDate(LocalDateTime.now()); // Обновление времени изменения статуса</b>
&nbsp;            //todo: реализовать резервирование товара
<b class="nc">&nbsp;            order.getItems().forEach(item -&gt; {</b>
<b class="nc">&nbsp;                int quantity = item.getQuantity().intValueExact(); // Безопасное преобразование, бросает ArithmeticException, если есть дробная часть.</b>
<b class="nc">&nbsp;                productService.reserveProduct(item.getProduct().getId(), quantity);</b>
<b class="nc">&nbsp;                logger.info(&quot;Product: &quot; + item.getProduct());</b>
&nbsp;            });
&nbsp;        }
<b class="nc">&nbsp;        return orderRepository.save(order);</b>
&nbsp;    }
&nbsp;    /**
&nbsp;     * Меняет статус заказа на &#39;PAID&#39; и сохраняет изменения в базе данных.
&nbsp;     *
&nbsp;     * @param orderId Идентификатор заказа, который нужно оплатить.
&nbsp;     * @return Обновленный заказ после оплаты.
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public Order payOrder(Long orderId) {
<b class="nc">&nbsp;        Order order = orderRepository.findById(orderId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Order not found with ID: &quot; + orderId));</b>
&nbsp;
<b class="nc">&nbsp;        if (order.getStatus() == OrderStatus.CONFIRMED || order.getStatus() == OrderStatus.NEW) {</b>
<b class="nc">&nbsp;            order.setStatus(OrderStatus.PAID);</b>
<b class="nc">&nbsp;            order.setStatusChangeDate(LocalDateTime.now());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Заказ должен быть заказ уже оплачен&quot;);</b>
&nbsp;        }
&nbsp;        //todo: реализовать оплату
&nbsp;        //todo: реализовать создание документа оплаты
&nbsp;        //todo: реализовать резервирование товара
<b class="nc">&nbsp;        return orderRepository.save(order);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Отгружает заказ по его идентификатору и создает новый документ реализации товаров
&nbsp;     * в который переносятся все данные из заказа, а затем уменьшает количество резервированных товаров
&nbsp;     * @param orderId идентификатор
&nbsp;     * @return
&nbsp;     */
&nbsp;    @Transactional
&nbsp;        public Order shipOrder(Long orderId) {
<b class="nc">&nbsp;        Order order = orderRepository.findById(orderId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Order not found with ID: &quot; + orderId));</b>
&nbsp;
<b class="nc">&nbsp;        if (order.getStatus() == OrderStatus.PAID) {</b>
<b class="nc">&nbsp;            order.setStatus(OrderStatus.SHIPPED);</b>
<b class="nc">&nbsp;            order.setStatusChangeDate(LocalDateTime.now());</b>
&nbsp;        }else {
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Заказ должен быть ОПЛАТЕН, прежде чем его можно будет ОТПРАВИТЬ&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return orderRepository.save(order);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Отменяет заказ по его идентификатору.
&nbsp;     * Переводит статус заказа в &quot;CANCELLED&quot; и возвращает резервированные товары на склад.
&nbsp;     *
&nbsp;     * @param orderId Идентификатор заказа для отмены.
&nbsp;     * @return Обновленный заказ.
&nbsp;     * @throws RuntimeException Если заказ не найден или не находится в статусе &quot;CONFIRMED&quot;.
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public Order cancelOrder(Long orderId) {
<b class="nc">&nbsp;        Order order = orderRepository.findById(orderId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Order not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        if (order.getStatus() != OrderStatus.SHIPPED) {</b>
<b class="nc">&nbsp;            order.setStatus(OrderStatus.CANCELLED);</b>
<b class="nc">&nbsp;            order.setStatusChangeDate(LocalDateTime.now()); // Обновление времени изменения статуса</b>
<b class="nc">&nbsp;            order.getItems().forEach(item -&gt; {</b>
<b class="nc">&nbsp;                int quantity = item.getQuantity().intValueExact(); // Безопасное преобразование</b>
<b class="nc">&nbsp;                productService.returnProduct(item.getProduct().getId(), quantity);</b>
&nbsp;            });
&nbsp;        }else{
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Order must be SHIPPED before it can be CANCELLED&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return orderRepository.save(order);</b>
&nbsp;    }
&nbsp;    //#endregion
&nbsp;
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Проверяет, принадлежит ли продукт другой организации, а не той, которая пытается сделать заказ.
&nbsp;     *
&nbsp;     * @param productId Идентификатор продукта.
&nbsp;     * @param organizationId Идентификатор организации, которая пытается сделать заказ.
&nbsp;     * @return true, если продукт принадлежит другой организации, иначе false.
&nbsp;     */
&nbsp;    public boolean isProductFromAnotherOrganization(Long productId, Long organizationId) {
<b class="nc">&nbsp;        Product product = productRepository.findById(productId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Product not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        return !product.getOrganization().getId().equals(organizationId);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Получает отфильтрованный список заказов на основе заданных критериев.
&nbsp;     *
&nbsp;     * @param sellerId Идентификатор продавца.
&nbsp;     * @param buyerOrganizationId Идентификатор покупателя.
&nbsp;     * @param status Статус заказа.
&nbsp;     * @param startDate Начальная дата периода.
&nbsp;     * @param endDate Конечная дата периода.
&nbsp;     * @return Список отфильтрованных заказов.
&nbsp;     */
&nbsp;    public List&lt;Order&gt; getFilteredOrders(Long sellerId,
&nbsp;                                         Long buyerOrganizationId,
&nbsp;                                         OrderStatus status, LocalDateTime startDate,
&nbsp;                                         LocalDateTime endDate) {
<b class="nc">&nbsp;        Specification&lt;Order&gt; spec = OrderSpecification.filterByCriteria(sellerId, buyerOrganizationId, status, startDate, endDate);</b>
<b class="nc">&nbsp;        return orderRepository.findAll(spec, Sort.by(&quot;orderDate&quot;).descending());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Удаляет продукт из заказа и сохраняет изменения в базе данных.
&nbsp;     *
&nbsp;     * @param orderId Заказ, из которого нужно удалить продукт.
&nbsp;     * @param orderItemId Идентификатор продукта, который нужно удалить.
&nbsp;     * @return Обновленный заказ после удаления продукта.
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public void removeProductFromOrder(Long orderId, Long orderItemId) {
<b class="nc">&nbsp;        Order order = orderRepository.findById(orderId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Order not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        OrderItem item = order.getItems().stream()</b>
<b class="nc">&nbsp;                .filter(i -&gt; i.getId().equals(orderItemId))</b>
<b class="nc">&nbsp;                .findFirst()</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Order item not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        order.getItems().remove(item);</b>
<b class="nc">&nbsp;        orderItemRepository.delete(item); // Удаление из репозитория элемента заказа</b>
<b class="nc">&nbsp;        orderRepository.save(order);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    public void updateProductQuantityInOrder(Long orderId, Long orderItemId, BigDecimal newQuantity) {
<b class="nc">&nbsp;        Order order = orderRepository.findById(orderId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Order not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        OrderItem item = order.getItems().stream()</b>
<b class="nc">&nbsp;                .filter(i -&gt; i.getId().equals(orderItemId))</b>
<b class="nc">&nbsp;                .findFirst()</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Order item not found&quot;));</b>
&nbsp;
&nbsp;        // Проверяем, что новое количество не превышает доступное количество на складе
<b class="nc">&nbsp;        if (item.getProduct().getQuantity().compareTo(newQuantity) &lt; 0) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Insufficient product stock&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        item.setQuantity(newQuantity);</b>
<b class="nc">&nbsp;        orderItemRepository.save(item); // Сохраняем измененное количество</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;OrderItem&gt; findOrderItemsByOrderId(Long orderId) {
<b class="nc">&nbsp;        List&lt;OrderItem&gt; items = orderRepository.findItemsByOrderId(orderId);</b>
<b class="nc">&nbsp;        logger.info(&quot;OrderItems for Order ID {}: {}&quot;, orderId, items);</b>
<b class="nc">&nbsp;        return items;</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;Order&gt; findNewOrdersByBuyerId(Long buyerOrganizationId) {
<b class="nc">&nbsp;        return orderRepository.findByBuyerOrganizationIdAndStatus(buyerOrganizationId, OrderStatus.NEW);</b>
&nbsp;
&nbsp;    }
&nbsp;    public List&lt;Order&gt; findOrdersByStatus(OrderStatus status) {
<b class="nc">&nbsp;        return orderRepository.findByStatus(status);</b>
&nbsp;    }
&nbsp;}
&nbsp;
&nbsp;
&nbsp;
&nbsp;
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-06-20 23:37</div>
</div>
</body>
</html>
